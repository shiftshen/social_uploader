# Social Uploader（本机 + Docker Desktop）使用文档

## 目标约束（重要）

- Docker Desktop 的“大文件”（镜像层、构建缓存、容器层等）必须放在移动硬盘：`/Volumes/M2USB/Docker`
- 项目业务数据（数据库、上传视频、日志）必须放在移动硬盘项目目录：`/Volumes/M2USB/Trae/Autosocialupload/Soialupload/new`

如果 Docker Desktop 的磁盘镜像仍在本机目录（例如 `~/Library/Containers/.../Docker.raw`），即使你把项目放在移动硬盘上，本机硬盘仍然会被 Docker 镜像/缓存占满。

## Docker 大文件实际在哪里（你现在的情况）

Docker Desktop 在 macOS 上把所有镜像/缓存/容器层封装进一个“磁盘镜像文件”里（常见文件名为 `Docker.raw` 或 `Docker.qcow2`）。

- 当前已确认 Docker Desktop 磁盘镜像位置（移动硬盘）：
  - `/Volumes/M2USB/Docker/Containers/DockerDesktop/Docker.raw`
- 当前已确认本机默认位置不存在 Docker.raw（不会继续吃本机磁盘）：
  - `~/Library/Containers/com.docker.docker/Data/vms/0/data/Docker.raw`

镜像、构建缓存、容器层并不会以“文件夹”的形式出现在你指定的项目目录里，而是集中存到这个 `Docker.raw` 内。

### 如何自检（建议每次迁移后做一次）

```bash
ls -lh ~/Library/Containers/com.docker.docker/Data/vms/0/data/Docker.raw
ls -lh /Volumes/M2USB/Docker/Containers/DockerDesktop/Docker.raw
docker system df
```

## 把 Docker 大文件迁移到移动硬盘（必须做）

1. 确保移动硬盘已挂载并可用：
   - 目标目录：`/Volumes/M2USB/Docker`
2. 打开 Docker Desktop
3. 进入：
   - Settings -> Resources -> Disk image location
4. 把 Disk image location 改为：
   - `/Volumes/M2USB/Docker`
5. 点击：
   - Apply & Restart
6. 等待 Docker Desktop 自动搬迁完成（可能耗时较长）

完成后你应该能在移动硬盘目录看到类似文件：
- `/Volumes/M2USB/Docker/Containers/DockerDesktop/Docker.raw`（或 `Docker.qcow2`）

## 本项目运行信息（名称 / 镜像 / 端口）

### 容器名称（container_name）

- 后端容器：`sau-backend`
- 前端容器：`sau-frontend`

查看命令：
```bash
docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}'
```

### 镜像名称

- 后端镜像：`new-backend:latest`
- 前端镜像：`new-frontend:latest`

查看命令：
```bash
docker images --format 'table {{.Repository}}:{{.Tag}}\t{{.ID}}\t{{.Size}}'
```

### 端口

- 前端（浏览器访问）：`http://localhost:5106`（宿主机 5106 -> 容器 80）
- 后端（API 服务）：`http://localhost:5406`（宿主机 5406 -> 容器 5406）

## 数据存储位置（可移动硬盘）

项目目录（建议永远不变）：
- `/Volumes/M2USB/Trae/Autosocialupload/Soialupload/new`

后端数据与配置（都在移动硬盘项目目录里）：
- 数据库文件：`/Volumes/M2USB/Trae/Autosocialupload/Soialupload/new/database.db`
- 配置文件：`/Volumes/M2USB/Trae/Autosocialupload/Soialupload/new/conf.py`
- 上传文件目录：`/Volumes/M2USB/Trae/Autosocialupload/Soialupload/new/videoFile/`
- 其他视频目录：`/Volumes/M2USB/Trae/Autosocialupload/Soialupload/new/videos/`
- 日志目录：`/Volumes/M2USB/Trae/Autosocialupload/Soialupload/new/logs/`

后端容器挂载关系（host -> container）来自：
- `/Volumes/M2USB/Trae/Autosocialupload/Soialupload/new/docker-compose.yml`

## GitHub 同步（更新 / 提交 / 推送）

Git 仓库根目录在：
- `/Volumes/M2USB/Trae/Autosocialupload/Soialupload`

日常拉取更新（推荐）：
```bash
cd /Volumes/M2USB/Trae/Autosocialupload/Soialupload
git status -sb
git pull --rebase
```

提交并推送到 main（示例）：
```bash
cd /Volumes/M2USB/Trae/Autosocialupload/Soialupload
git checkout main
git add -A
git commit -m "fix: 修复接口与 Docker 构建问题"
git push
```

如果是首次绑定远端仓库（本地还没有 origin）：
```bash
cd /Volumes/M2USB/Trae/Autosocialupload/Soialupload
git remote add origin <你的 GitHub 仓库地址>
git push -u origin main
```

## Docker 构建常见问题：macOS 的 ._* 文件

如果你在 macOS 上通过访达/拷贝操作过项目目录，可能会产生 `._*` 文件（AppleDouble），会导致 Docker 构建报错：`failed to xattr ... operation not permitted`。

清理命令：
```bash
cd /Volumes/M2USB/Trae/Autosocialupload/Soialupload/new
find . -name "._*" -delete
```

## 日常使用（最常用命令）

在目录执行：
- `/Volumes/M2USB/Trae/Autosocialupload/Soialupload/new`

启动：
```bash
docker-compose up -d
```

停止：
```bash
docker-compose down
```

查看日志：
```bash
docker logs -f sau-backend
docker logs -f sau-frontend
```

重建并启动（代码有更新时）：
```bash
docker-compose up -d --build
```

一键恢复脚本（会重建并启动）：
```bash
cd /Volumes/M2USB/Trae/Autosocialupload/Soialupload
./restore.sh
```

## 排障与容量管理（建议收藏）

查看 Docker 占用：
```bash
docker system df
```

清理构建缓存（通常最占空间）：
```bash
docker builder prune -af
```

清理未使用镜像/容器（谨慎）：
```bash
docker system prune -af
```

## 关键提醒（否则会“看起来迁移了但还是占本机”）

- Docker Desktop 必须在移动硬盘挂载后再启动，否则它可能继续使用本机的 `Docker.raw`。
- 即使项目目录在移动硬盘，只要 Docker Desktop 的 Disk image location 在本机，镜像/缓存仍然占本机硬盘。
